// @license   http://www.gnu.org/licenses/gpl.html GNU/GPL
const p2s_product_form={data:()=>({base_url:"",form:{itemid:0,jform_title:"",jform_catid:"",jform_short_description:"",jform_long_description:"",jform_access:"",jform_base_price:0,jform_sku:"",jform_manage_stock:!0,jform_stock:"",jform_featured:!1,jform_state:!1,jform_taxable:!1,jform_show_discount:!1,jform_discount:0,jform_discount_type:"amount",jform_teaserimage:"",jform_fullimage:"",jform_shipping_mode:0,jform_flatfee:0,jform_weight:0,jform_weight_unit:0,jform_publish_up_date:"",jform_product_type:"",jform_tags:[],jform_options:[],jform_variants:[],jform_variantList:[],files:[]},product_id:0,product_type:1,custom_fields:[],available_tags:[],option_for_edit:[],p2s_currency:[],p2s_local:"",discount_type:1,andClose:!1,variantsSet:!1,file_for_edit:{},newOptionTypeName:"",newOptionTypeType:"Dropdown",showNewOptionTypeNameWarning:!1,variants_loading:!1,setSavedClass:!1,media_view:"table",selected_images:[],selected_folders:[],folderTree:[],breadcrumbs:[],currentParent:0,currentFolderId:0,mediaLoading:!1,COM_PROTOSTORE_ADD_PRODUCT_ALERT_SAVED:"",COM_PROTOSTORE_MEDIA_MANAGER_EDIT_NAME_PROMPT:"",COM_PROTOSTORE_MEDIA_MANAGER_DELETE_ARE_YOU_SURE:"",COM_PROTOSTORE_MEDIA_MANAGER_FOLDER_ADD_FOLDER_PROMPT:"",COM_PROTOSTORE_MEDIA_MANAGER_DROPZONE_LABEL:""}),created(){emitter.on("p2s_product_file_upload",this.fileUploaded)},computed:{currentDirectory(){return this.folderTree.find((e=>e.id===this.currentParent))},modifierValueInputType(){return"perc"===this.option_for_edit.modifiertype?"[0-9]*":"amount"===this.option_for_edit.modifiertype?"^[0-9]+(.[0-9]{1,2})?$":void 0},singleSelection(){return 1!==this.selected_images.length||0!==this.selected_folders.length},singleFolderSelection(){return 1!==this.selected_folders.length||0!==this.selected_images.length},somethingIsSelected(){return this.selected_folders.length>0||this.selected_images.length>0},checkDeleteDisabled(){return 0===this.selected_images.length&&0===this.selected_folders.length},checkEditDisabled(){return 0===this.selected_images.length&&0===this.selected_folders.length||this.selected_images.length>1&&this.selected_folders.length>1},sellPrice(){const e={maximumFractionDigits:2,currency:this.p2s_currency.iso,style:"currency",currencyDisplay:"symbol"};if("amount"===this.form.jform_discount_type)return this.localStringToNumber(this.form.jform_base_price-this.form.jform_discount).toLocaleString(this.p2s_local,e);{const t=this.form.jform_base_price/100*this.form.jform_discount;return this.localStringToNumber(this.form.jform_base_price-t).toLocaleString(this.p2s_local,e)}}},async beforeMount(){const e=document.getElementById("base_url");if(null!=e)try{this.base_url=e.innerText,e.remove()}catch(e){}const t=document.getElementById("currency");if(null!=t)try{this.p2s_currency=JSON.parse(t.innerText),t.remove()}catch(e){}const i=document.getElementById("locale");if(null!=i)try{this.p2s_local=i.innerText,i.remove()}catch(e){}const o=document.getElementById("folderTree_data");if(null!=o)try{this.folderTree=JSON.parse(o.innerText)}catch(e){}const r=document.getElementById("default_category_data");if(null!=r)try{this.form.jform_category=r.innerText,r.remove()}catch(e){}const s=document.getElementById("custom_fields_data");if(null!=s)try{this.custom_fields=JSON.parse(s.innerText)}catch(e){}const a=document.getElementById("jform_joomla_item_id_data");if(null!=a){try{this.form.itemid=a.innerText}catch(e){}const e=document.getElementById("jform_images_data");if(null!=e)try{const t=JSON.parse(e.innerText);this.form.jform_teaserimage=t.image_intro,this.form.jform_fullimage=t.image_fulltext}catch(e){}this.setData();const t=document.getElementById("COM_PROTOSTORE_ADD_PRODUCT_ALERT_SAVED");if(null!=t)try{this.COM_PROTOSTORE_ADD_PRODUCT_ALERT_SAVED=t.innerText,t.remove()}catch(e){}}const n=document.getElementById("available_tags_data");if(null!=n)try{this.available_tags=JSON.parse(n.innerText)}catch(e){}this.form.jform_options=[];const c=document.getElementById("options");if(null!=c)try{this.form.jform_options=JSON.parse(c.innerText),c.remove()}catch(e){this.form.jform_options=[]}else this.form.jform_options=[];const m=document.getElementById("COM_PROTOSTORE_MEDIA_MANAGER_EDIT_NAME_PROMPT");if(null!=m)try{this.COM_PROTOSTORE_MEDIA_MANAGER_EDIT_NAME_PROMPT=m.innerText,m.remove()}catch(e){}const _=document.getElementById("COM_PROTOSTORE_MEDIA_MANAGER_DELETE_ARE_YOU_SURE");if(null!=_)try{this.COM_PROTOSTORE_MEDIA_MANAGER_DELETE_ARE_YOU_SURE=_.innerText,_.remove()}catch(e){}const l=document.getElementById("COM_PROTOSTORE_MEDIA_MANAGER_FOLDER_ADD_FOLDER_PROMPT");if(null!=l)try{this.COM_PROTOSTORE_MEDIA_MANAGER_FOLDER_ADD_FOLDER_PROMPT=l.innerText,l.remove()}catch(e){}const d=document.getElementById("COM_PROTOSTORE_MEDIA_MANAGER_UPLOADED_MODAL");if(null!=d)try{this.COM_PROTOSTORE_MEDIA_MANAGER_UPLOADED_MODAL=d.innerText,d.remove()}catch(e){}const f=document.getElementById("COM_PROTOSTORE_MEDIA_MANAGER_DROPZONE_LABEL");if(null!=f)try{this.COM_PROTOSTORE_MEDIA_MANAGER_DROPZONE_LABEL=f.innerText,f.remove()}catch(e){}},mounted(){this.form.jform_discount_type||(this.form.jform_discount_type="amount")},methods:{removeImage(e){"jform_teaserimage"==e?this.form.jform_teaserimage="":"jform_fullimage"==e&&(this.form.jform_fullimage="")},logIt(){console.log(this.custom_fields)},addTagFromChip(e,t){this.form.jform_tags.push(e),this.available_tags.splice(t,1)},addBackToAvailable(e){this.available_tags.push(e.value[0])},addVariant(){let e={id:0,product_id:this.form.itemid,name:"",labels:[]};this.form.jform_variants.push(e)},async removeVariant(e){await UIkit.modal.confirm(this.COM_PROTOSTORE_MEDIA_MANAGER_DELETE_ARE_YOU_SURE),this.form.jform_variants[e].labels=[],this.form.jform_variants.splice(e,1),await this.setVariants(),await this.saveItem()},async updateVariantValues(){this.variants_loading=!0,clearTimeout(this.debounce),this.debounce=setTimeout((()=>{this.saveVariantValues()}),1600)},async setVariants(){this.variants_loading=!0;const e={variants:this.form.jform_variants,variantList:this.form.jform_variantList,itemid:this.form.itemid,base_price:this.form.jform_base_price},t=await fetch(this.base_url+"index.php?option=com_ajax&plugin=protostore_ajaxhelper&method=post&task=task&type=product.saveVariants&format=raw",{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(e)});if((await t.json()).success)return this.variants_loading=!1,this.setSavedClass=!0,setTimeout((()=>{this.setSavedClass=!1}),3e3),await this.refreshVariants()},async saveVariantValues(){this.variants_loading=!0;const e={variantList:this.form.jform_variantList},t=await fetch(this.base_url+"index.php?option=com_ajax&plugin=protostore_ajaxhelper&method=post&task=task&type=product.updateVariantValues&format=raw",{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(e)});if((await t.json()).success)return this.variants_loading=!1,this.setSavedClass=!0,setTimeout((()=>{this.setSavedClass=!1}),3e3),await this.refreshVariants()},async refreshVariants(){const e={j_item_id:this.form.itemid},t=await fetch(this.base_url+"index.php?option=com_ajax&plugin=protostore_ajaxhelper&method=post&task=task&type=product.refreshVariants&format=raw",{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(e)}),i=await t.json();if(i.success)return this.form.jform_variantList=i.data.variantList,this.form.jform_variants=i.data.variants,!0},setVariantDefault(e){this.form.jform_variantList.forEach(((t,i)=>{t.default=!1,e===i&&(t.default=!0,t.active||(t.active=!0))}))},checkVariantDefault(e){this.form.jform_variantList.forEach(((t,i)=>{if(e===i&&t.default)return t.active=!0,!1}))},formatToCurrency(e){const t=e,i={maximumFractionDigits:2,currency:this.p2s_currency.iso,style:"currency",currencyDisplay:"symbol"};e=this.localStringToNumber(t).toLocaleString(void 0,i)},localStringToNumber:e=>Number(String(e).replace(/[^0-9.-]+/g,"")),async addLabel(e,t){let i=e.value;console.log(i);let o=i[i.length-1];i.splice(-1),i.push({id:0,name:o,product_id:this.form.itemid,variant_id:t})},async onAddNewLabel(e,t){await this.addLabel(e,t),await this.setVariants(),await this.saveItem()},async removeLabel(e,t,i){this.form.jform_variants[t].labels.push(e.value[0]),await UIkit.modal.confirm(this.COM_PROTOSTORE_MEDIA_MANAGER_DELETE_ARE_YOU_SURE),this.form.jform_variants[t].labels.splice(-1),await this.setVariants(),await this.saveItem()},addOption(){this.form.jform_options.push({id:0,option_name:"",modifier_type:"amount",modifier_value:0,delete:!1})},removeOption(e){e.delete=!0},openFileEdit(e){this.file_for_edit=e,this.openAddFile()},openAddFile(){UIkit.modal("#fileEditModal").show()},removeFile(){this.file_for_edit.filename_obscured=!1},fileUploaded(e){this.file_for_edit.filename_obscured=e.path,this.file_for_edit.filename=e.filename},async saveFile(){const e={fileid:this.file_for_edit.id,created:this.file_for_edit.created,download_access:this.file_for_edit.download_access,filename:this.file_for_edit.filename,filename_obscured:this.file_for_edit.filename_obscured,isjoomla:this.file_for_edit.isjoomla?1:0,php_min:this.file_for_edit.php_min,published:this.file_for_edit.published?1:0,stability_level:this.file_for_edit.stability_level,type:this.file_for_edit.type,version:this.file_for_edit.version,product_id:this.product_id},t=await fetch(this.base_url+"index.php?option=com_ajax&plugin=protostore_ajaxhelper&method=post&task=task&type=file.save&format=raw",{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(e)});(await t.json()).success?UIkit.notification({message:this.COM_PROTOSTORE_ADD_PRODUCT_ALERT_SAVED,status:"success",pos:"top-center",timeout:5e3}):UIkit.notification({message:"There was an error.",status:"danger",pos:"top-center",timeout:5e3})},cancelFile(){this.file_for_edit={}},async saveItem(){this.form.jform_long_description=this.getFrameContents("jform_long_description"),this.form.jform_short_description=this.getFrameContents("jform_short_description"),this.form.jform_publish_up_date=document.getElementById("jform_publish_up_date").value,this.form.jform_access=document.getElementById("jform_access").value;const e={itemid:this.form.itemid,title:this.form.jform_title,introtext:this.form.jform_short_description,fulltext:this.form.jform_long_description,category:this.form.jform_catid,access:this.form.jform_access,base_price:this.form.jform_base_price,discount:this.form.jform_discount,discount_type:this.form.jform_discount_type,tags:this.form.jform_tags,sku:this.form.jform_sku,stock:this.form.jform_stock,manage_stock:this.form.jform_manage_stock?1:0,featured:this.form.jform_featured?1:0,state:this.form.jform_state?1:0,taxable:this.form.jform_taxable?1:0,teaserimage:this.form.jform_teaserimage,fullimage:this.form.jform_fullimage,shipping_mode:this.form.jform_shipping_mode,flatfee:this.form.jform_flatfee,weight:this.form.jform_weight,weight_unit:this.form.jform_weight_unit,publish_up_date:this.form.jform_publish_up_date,product_type:this.form.jform_product_type,options:this.form.jform_options,variants:this.form.jform_variants,variantList:this.form.jform_variantList,custom_fields:this.custom_fields},t=await fetch(this.base_url+"index.php?option=com_ajax&plugin=protostore_ajaxhelper&method=post&task=task&type=product.save&format=raw",{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(e)}),i=await t.json();if(i.success)if(this.form.jform_options=i.data.options,UIkit.notification({message:this.COM_PROTOSTORE_ADD_PRODUCT_ALERT_SAVED,status:"success",pos:"bottom-right",timeout:5e3}),this.andClose)window.location.href=this.base_url+"index.php?option=com_protostore&view=products";else{const e=window.location.href;-1==e.indexOf("&id=")&&history.replaceState("","",e+"&id="+i.data.joomlaItem.id),this.form.itemid=i.data.joomlaItem.id}else UIkit.notification({message:"There was an error.",status:"danger",pos:"top-center",timeout:5e3})},getSellPrice(){},getFrameContents(e){const t=document.getElementById(e+"_ifr");let i;return t.contentDocument?i=t.contentDocument.getElementById("tinymce"):t.contentWindow&&(i=t.contentWindow.document.getElementById("tinymce")),i.innerHTML},setData(){Object.keys(this.form).forEach((e=>{let t=document.getElementById(e+"_data");t&&(this.hasJsonStructure(t.innerText)?this.form[e]=JSON.parse(t.innerText):(this.form[e]=t.innerText,1==t.innerText&&(this.form[e]=!0),0==t.innerText&&(this.form[e]=!1),"null"==t.innerText&&(this.form[e]=[]),"jform_base_price_data"!==t.id&&"jform_discount_data"!==t.id&&"jform_flatfee_data"!==t.id||(this.form[e]=Number(t.innerText)/100)))}))},hasJsonStructure(e){if("string"!=typeof e)return!1;try{const t=JSON.parse(e),i=Object.prototype.toString.call(t);return"[object Object]"===i||"[object Array]"===i}catch(e){return!1}},serialize(e){var t=[];for(var i in e)e.hasOwnProperty(i)&&t.push(encodeURIComponent(i)+"="+encodeURIComponent(e[i]));return t.join("&")},async getFolderTree(){this.mediaLoading=!0,this.selected_images=[],this.selected_folders=[];const e=await fetch(this.base_url+"index.php?option=com_ajax&plugin=protostore_ajaxhelper&method=post&task=task&type=mediaManager.getFolderTree&format=raw",{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:""}),t=await e.json();t.success&&(this.mediaLoading=!1,this.selected_images=[],this.folderTree=t.data)},async openBreadcrumb(e,t){this.selected_images=[],this.selected_folders=[],this.breadcrumbs.splice(t+1,this.breadcrumbs.length),this.currentParent=e.id},async openFolder(e){this.selected_images=[],this.selected_folders=[],this.breadcrumbs.push(e),this.currentParent=e.id},async setToHome(){this.selected_images=[],this.selected_folders=[],this.breadcrumbs=[],this.currentParent=0},toggleSelectImage(e){const t=this.selected_images.indexOf(e);t>-1?this.selected_images.splice(t,1):this.selected_images.push(e)},selectFile(e){this.selected_images.push(e)},selectImage(e){Object.keys(this.form).forEach((t=>{t==e&&(this.form[t]=this.selected_images[0].relname)}));const t=this.custom_fields.find((t=>t.id===e));t&&(t.value=this.selected_images[0].relname),UIkit.modal("#mediaField"+e).hide()},async editFileName(){const e=await UIkit.modal.prompt(this.COM_PROTOSTORE_MEDIA_MANAGER_EDIT_NAME_PROMPT,this.selected_images[0].name,{stack:!0});if(e){const t={image:this.selected_images[0],new_name:e},i=await fetch(this.base_url+"index.php?option=com_ajax&plugin=protostore_ajaxhelper&method=post&task=task&type=mediaManager.editName&format=raw",{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(t)});(await i.json()).success&&await this.getFolderTree()}},async editFolderName(){const e=await UIkit.modal.prompt(this.COM_PROTOSTORE_MEDIA_MANAGER_EDIT_NAME_PROMPT,this.selected_folders[0].name,{stack:!0});if(e){const t={folder:this.selected_folders[0],new_name:e},i=await fetch(this.base_url+"index.php?option=com_ajax&plugin=protostore_ajaxhelper&method=post&task=task&type=mediaManager.editFolderName&format=raw",{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(t)});(await i.json()).success&&(this.selected_images=[],this.selected_folders=[],await this.getFolderTree())}},async trashSelected(){await UIkit.modal.confirm(this.COM_PROTOSTORE_MEDIA_MANAGER_DELETE_ARE_YOU_SURE,{stack:!0});const e={folders:this.selected_folders,images:this.selected_images},t=await fetch(this.base_url+"index.php?option=com_ajax&plugin=protostore_ajaxhelper&method=post&task=task&type=mediaManager.trashSelected&format=raw",{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(e)});(await t.json()).success&&await this.getFolderTree()},async addFolder(){const e=await UIkit.modal.prompt(this.COM_PROTOSTORE_MEDIA_MANAGER_FOLDER_ADD_FOLDER_PROMPT,"",{stack:!0});if(e){const t={name:e,currentDirectory:this.currentDirectory},i=await fetch(this.base_url+"index.php?option=com_ajax&plugin=protostore_ajaxhelper&method=post&task=task&type=mediaManager.addFolder&format=raw",{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(t)});(await i.json()).success&&await this.getFolderTree()}},async uploadImage(e){this.mediaLoading=!0,[...e.target.files].forEach((e=>{let t=new FormData;t.append("image",e,e.name),fetch(this.base_url+"index.php?option=com_ajax&plugin=protostore_ajaxhelper&method=post&task=task&type=mediaManager.uploadImage&format=raw&directory="+this.currentDirectory.fullname,{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",redirect:"follow",referrerPolicy:"no-referrer",reportProgress:!0,observe:"events",body:t}).then((e=>{e.success}))})),UIkit.notification({message:this.COM_PROTOSTORE_MEDIA_MANAGER_UPLOADED_MODAL,status:"success",pos:"bottom-right",timeout:5e3}),await this.getFolderTree()}},components:{"p-inputswitch":primevue.inputswitch,"p-chips":primevue.chips,"p-chip":primevue.chip,"p-inputnumber":primevue.inputnumber,"p-multiselect":primevue.multiselect}};Vue.createApp(p2s_product_form).mount("#p2s_product_form");